//>>built
define("epi-cms/widget/ContextualContentForestStoreModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/topic","dojo/when","epi/shell/TypeDescriptorManager","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/core/ContentReference","epi-cms/widget/ContentForestStoreModel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2([_c,_a],{previousSelection:null,forThisFolderEnabled:true,postscript:function(){this.inherited(arguments);this._handles.push(_7.subscribe("/epi/cms/action/createlocalasset",_3.hitch(this,this.refreshRoots)));this._handles.push(_7.subscribe("/epi/cms/action/togglecreatemode",_3.hitch(this,this._toggleContextualContent)));this._handles.push(_4.around(this,"pasteItem",_3.hitch(this,this._aroundPasteItem)));this._handles.push(_4.around(this,"pasteItems",_3.hitch(this,this._aroundPasteItems)));this._handles.push(_4.after(this.store,"get",_3.hitch(this,this._afterStoreGet)));},contextChanged:function(_d,_e){this.inherited(arguments);this.refreshRoots();},getChildren:function(_f,_10,_11){if(_f===this.root){_8(this._getRootItems(),_10,_11);}else{if(this.isPseudoContextualRoot(_f)){_10([]);return;}this.inherited(arguments);}},getAncestors:function(_12,_13){var _14=this.getInherited(arguments),_15=_13;_8(this.getCurrentContent()).then(_3.hitch(this,function(_16){var _17=this.roots.concat(_16.assetsFolderLink),_18=_3.hitch(this,function(_19){var _1a;for(var i=_19.length-1;i>=0;i--){_1a=_19[i];if(this.isContextualRoot(_1a)){_19[i]=this.getContextualRoot(_1a);}if(_1.indexOf(_17,this.getIdentity(_1a))>=0){_19=_19.slice(i);_19.unshift(this.root);_13(_19);return;}}_13([this.root]);});if(_1.indexOf(_17,this.getIdentity(_12))>=0){_13([this.root]);}_15=_18;})).always(_3.hitch(this,function(){_14.apply(this,[_12,_15]);}));},getObjectIconClass:function(_1b,_1c){var _1d=this._currentContext&&this._currentContext.dataType;if(!_1d){return this.inherited(arguments);}var _1e=_9.getValue(_1d,"iconClass");return this.isContextualContent(_1b)?(_1e?_1c+" "+_1e+"Contextual":_1c):this.inherited(arguments);},onToggleContentDisplay:function(_1f,_20){},onRefreshRoots:function(_21){},refreshRoots:function(_22){if(_22===this){return true;}var _23=this;return _8(_23._getRootItems(),function(_24){_23.onChildrenChange(_23.root,_24);});},canCopy:function(_25){return this.isContextualContent(_25)?false:this.inherited(arguments);},canCut:function(_26){return this.isContextualContent(_26)?false:this.inherited(arguments);},canPaste:function(_27,_28,_29){var _2a=this,_2b=this.inherited(arguments),_2c=new _5();if(_29){_2c.resolve(_2b);}else{_2a.getAncestors(_28,function(_2d){var _2e=_2a.isContextualContent(_28)||_2a.hasContextual(_2d);if(_2e){_8(_2a.getCurrentContent()).then(function(_2f){if(_b.compareIgnoreVersion(_27.contentLink,_2f.contentLink)){_2c.resolve(false);}else{_2a.getAncestors(_2f.contentLink,function(_30){var _31=_1.some(_30,function(_32){return _27.contentLink===_32.contentLink;},this);_2c.resolve(_31?false:_2b);});}}).otherwise(function(){_2c.resolve(false);});}else{_2c.resolve(_2b);}});}return _2c.promise;},filterAncestors:function(_33){if(!(_33 instanceof Array)){return _33;}var _34=_33.indexOf(this._getPseudoContextualContent().toString());if(_34!==-1&&_34<_33.length-1){_33.splice(_34,1);}return _33;},isContextualContent:function(_35){return !!_35&&this.isSupportedType(_35.typeIdentifier)&&this.inherited(arguments);},_toggleContextualContent:function(_36){_8(this.getCurrentContent(),_3.hitch(this,function(_37){this.onToggleContentDisplay(_37.assetsFolderLink,!_36);this._setSelection(null);}));},_setSelection:function(_38){var _39=this.roots.length>0?this.roots[0].toString():(!_38?null:_38.assetsFolderLink),_3a=_38!=null?_38.contentLink:_39,_3b=this.get("previousSelection"),_3c=this.get("previousContextualSelection"),_3d=_3c&&_3c.selectedContent,_3e=new _5();if(!(_3a&&_3b)){_3e.resolve();return _3e.promise;}var _3f=false,_40=_3b.selectedContent,_41=_3b.selectedAncestors,_42=_40.item&&!_40.item.contentLink;var _43=function(){_3e.resolve();};if(_42||this.hasContextual(_41)){this.onSelect(_3a,_3f,_43);}else{if(_40.item.contentLink===_39&&_3d&&_3d.item&&_3d.item.contentLink){this.onSelect(_3d.item.contentLink,_3f,_43);}else{_3e.resolve();}}return _3e.promise;},getRoots:function(_44){var def=new _5();var _45=this._getPseudoContextualContent().toString();var _46=function(_47){if(!_44){return true;}return _47!==_45;};var _48=function(_49){return _49.contentLink;};_8(this._getRootItems(),function(_4a){def.resolve(_4a.map(_48).filter(_46));},def.reject);return def.promise;},_getRootItems:function(){var _4b=this,_4c=_4b.store,_4d=_1.map(_4b.roots,function(_4e){return _4c.get(_4e);});var _4f=_8(_6([_4b.getCurrentContent(),_4b.getCurrentContext()]),function(_50){var _51=_50[0],_52=_50.length>1?_50[1]:null;var _53=new _b(_51.contentLink).createVersionUnspecificReference().toString();return _8(_4c.get(_53),function(_54){var _55=_52&&_52.currentMode==="create";if((_55&&_4b.get("view")==="contentselector")||!_4b.canHaveContextualContent(_54)||!_4b.forThisFolderEnabled){return null;}var _56=_54.assetsFolderLink;if(_56){var _57=function(_58){return _8(_4c.get(_58),function(_59){var _5a={id:_59.contentLink,typeIdentifiers:_4b.typeIdentifiers,allLanguages:_4b.showAllLanguages};return _8(_4c.query(_5a),function(_5b){if(typeof _4b.isSupportedType==="function"&&!_4b.isSupportedType(_5b.typeIdentifier)){return null;}if(!_4b.isPseudoContextualRoot(_5b)){return _4b.getContextualRoot(_5b);}else{return _8(_4b.onRefreshRoots(_5b),function(){return _4b._modifyContentAccess(_5b,_54);});}});});};if(_56===_4b._getPseudoContextualContent().toString()){return _8(_4c.refresh(_53),function(_5c){return _57(_5c.assetsFolderLink);});}else{return _57(_56);}}return null;});},function(){return null;});_4d.push(_4f);return _8(_6(_4d),function(_5d){return _1.filter(_5d,Boolean);});},_aroundPasteItem:function(_5e){var _5f=this;return function(_60,_61,_62,_63,_64){var _65=_62,_66=_5f.get("createAsLocalAsset");return _8(_5f.getCurrentContent()).then(function(_67){if(!_66){_66=_5f.isPseudoContextualRoot(_65);_5f.set("createAsLocalAsset",_66);}_66&&(_65=_67);}).always(function(){return _8(_5e.apply(_5f,[_60,_61,_65,_63,_64]),function(_68){if(_66){_5f.set("createAsLocalAsset",false);return _8(_5f.refreshRoots(),function(){_7.publish("/epi/cms/action/createlocalasset",_5f);return _68;});}else{return _68;}});});};},_aroundPasteItems:function(_69){var _6a=this;return function(_6b,_6c,_6d,_6e){var _6f=_6a.get("createAsLocalAsset");return _8(_6a.getCurrentContent()).then(function(_70){if(!_6f){_6f=_6a.isPseudoContextualRoot(_6c);_6a.set("createAsLocalAsset",_6f);}_6f&&(_6c=_70);}).always(function(){return _8(_69.apply(_6a,[_6b,_6c,_6d,_6e]),function(_71){if(_6f){_6a.set("createAsLocalAsset",false);}else{return _71;}});});};},_afterStoreGet:function(_72){var _73=this;return _8(_72,function(_74){return _8(_73.getCurrentContent(),function(_75){return _73._modifyContentAccess(_74,_75);},function(_76){return _74;});});},_modifyContentAccess:function(_77,_78){if(this.isContextualContent(_77)){var _79=this.getContextualRoot(_77);return this.isPseudoContextualRoot(_77)?_3.mixin(_79,{isPreferredLanguageAvailable:_78.isPreferredLanguageAvailable,hasTranslationAccess:_78.hasTranslationAccess,accessMask:_78.accessRights,ownerContentLink:_78.contentLink}):_79;}return _77;}});});