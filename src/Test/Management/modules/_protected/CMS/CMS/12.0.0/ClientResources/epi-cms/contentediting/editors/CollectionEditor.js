//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/CollectionEditor.html":"<div class=\"dijitInline\">\r\n    <div class=\"command-area\"><div data-dojo-attach-point=\"commandTargetNode\"></div></div>\r\n    <div data-dojo-attach-point=\"gridNode\"></div>\r\n</div>"}});define("epi-cms/contentediting/editors/CollectionEditor",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-construct","dojo/dom-class","dojo/json","dojo/on","dojo/Stateful","dojo/when","dijit/_TemplatedMixin","dijit/_Widget","dgrid/Keyboard","dgrid/OnDemandGrid","dgrid/Selection","dgrid/extensions/ColumnResizer","dgrid/extensions/ColumnReorder","put-selector/put","epi/shell/dgrid/Formatter","epi/shell/widget/_ModelBindingMixin","epi/shell/widget/FormContainer","epi/string","epi/shell/command/withConfirmation","epi-cms/contentediting/editors/model/CollectionEditorModel","epi-cms/contentediting/editors/model/CollectionEditorItemModel","epi-cms/contentediting/_EditorWrapperBase","epi-cms/dgrid/DnD","epi-cms/dgrid/formatters","epi-cms/dgrid/WithContextMenu","epi-cms/contentediting/editors/DefaultGridAssembler","./_AddItemDialogMixin","dojo/text!./templates/CollectionEditor.html","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.collectioneditor"],function(_1,_2,_3,_4,_5,_6,_7,on,_8,_9,_a,_b,_c,_d,_e,_f,_10,put,_11,_12,_13,_14,_15,_16,_17,_18,DnD,_19,_1a,_1b,_1c,_1d,_1e){return _2([_b,_a,_12,_1c],{templateString:_1d,multiple:true,baseClass:"epi-collection-editor",value:null,model:null,modelType:_16,itemType:null,generateColumns:true,excludedColumns:null,includedColumns:null,gridType:_2([_d,_11,_e,_c,DnD,_f,_10,_1a]),gridAssemblerType:_1b,gridSettings:null,itemModelType:null,itemEditorType:_13,useFullWidth:true,_noDataMessage:"<span><span class=\"dijitReset dijitInline\">"+_1e.noitems+"</span></span>",_currentProviderHandler:null,postMixInProperties:function(){this.inherited(arguments);this.dialogParams=_3.mixin(this.dialogParams,{"class":this.baseClass+"--dialog"});this.itemModelType=this.itemModelType||_17;this.model=this.model||new this.modelType({itemType:this.itemType,itemModelType:this.itemModelType,data:this.value,availableCommands:this.commands});this.own(this.model);this.own(on(this.model,"itemsChanged",_3.hitch(this,this._onItemsChanged)));this.gridSettings=_3.mixin(this.gridSettings||{},{noDataMessage:this._noDataMessage});if(this.readOnly){this.allowedDndTypes=[];this.gridSettings.dndDisabled=true;}this.gridSettings.dndParams={copyOnly:true,accept:this.allowedDndTypes||[],creator:_3.hitch(this,this._dndNodeCreator)};},postCreate:function(){this.inherited(arguments);_9(this.model.initialize(),_3.hitch(this,function(){if(this._destroyed){return;}this._setupGrid();}));},onChange:function(_1f){},_setValueAttr:function(_20){this._set("value",_20);if(this.model){this.model.set("data",_20);}},_dndNodeCreator:function(_21,_22){var _23=_5.create("div");return {node:_23,type:this.allowedDndTypes,data:_21};},_setupGrid:function(){var _24=this._getGridDefinition();var _25=new this.gridAssemblerType({gridType:this.gridType,gridSettings:this.gridSettings,columnDefinitions:_24,listCommands:this.readOnly?[]:this.model.getListCommands(),itemCommandsFactory:_3.hitch(this,function(_26,_27){return this.readOnly?[]:this.model.getItemCommands(_26,this.commands,_27);})});this.own(this.grid=_25.build(this.gridNode,this.commandTargetNode));_6.add(this.gridNode,"epi-plain-grid-modal epi-plain-grid--margin-bottom epi-plain-grid--cell-borders");if(!this.gridSettings.dndDisabled){this._setupDnD();}var _28=this.model.get("items");this.grid.renderArray(_28);if(!_28||_28.length<=0){this._renderNoDataMessage();}this.own(this.grid.on(".dgrid-row:click",_3.hitch(this,this.onGridRowClick)));this.own(this.grid.on(".dgrid-row:dblclick",_3.hitch(this,this.onGridRowDblClick)));},_setupDnD:function(){this.own(_4.after(this.grid.dndSource,"onDropData",_3.hitch(this,this.onDndDrop),true));},onDndDrop:function(_29,_2a,_2b,_2c){var i;if(this.grid.dndSource===_2a){for(i=0;i<_2b.length;i++){this.model.moveItem(this.grid.dndSource.getItem(_2b[i].id).data,this.grid.dndSource.current!=null?this.grid.dndSource.getItem(this.grid.dndSource.current.id).data:null,this.grid.dndSource.before);}}else{this.onDropping&&this.onDropping();this.onFocus();for(i=0;i<_29.length;i++){this._addItem(_29[i]);if(_2a&&_2a.grid&&_2a.grid.consumer&&_2a.grid.consumer!==this){_2a.grid.consumer.model.removeItem(this.grid.dndSource.getItem(_2b[i].id).data);}}}},_addItem:function(_2d){_9(this._dndGetItemData(_2d),_3.hitch(this,function(_2e){this.model.addItem(_2e,this.grid.dndSource.current!=null?this.grid.dndSource.getItem(this.grid.dndSource.current.id).data:null,this.grid.dndSource.before);}));},_dndGetItemData:function(_2f){return _2f.data;},_getGridDefinition:function(){var _30=this.generateColumns?this.model.generateColumnsDefinition(this.excludedColumns):this.includedColumns||{};return this.model.generateFormatters(_30);},_onGridRowSelect:function(e){if(!this.grid.itemCommandProviderMap){return;}if(this._currentProviderHandler){this._currentProviderHandler.removeProvider();}var _31=this.grid.row(e).data;this._currentProviderHandler=this.grid.contextMenu.addProvider(this.grid.itemCommandProviderMap[_7.stringify(_31)]);},onGridRowClick:function(e){this._onGridRowSelect(e);},onGridRowDblClick:function(e){if(this.readOnly){return;}var _32={model:this.grid.row(e).data};this.model.editItemDelegate(_32);},_getDialogConfirmActionText:function(){return this.gridSettings.confirmActionText?this.gridSettings.confirmActionText:this.inherited(arguments);},onExecuteDialog:function(){var _33=this._itemEditor.get("value");if(this._editingItemIndex!==undefined){this.model.saveItem(_33,this._editingItemIndex);}else{this.model.addItem(_33);}},_onCancelDialog:function(){this.inherited(arguments);this._onBlur();},_onItemsChanged:function(_34){if(this.grid){for(var _35 in this.grid.itemCommandProviderMap){delete this.grid.itemCommandProviderMap[_35];}this.grid.refresh();this.grid.renderArray(_34);if(!_34||_34.length<=0){this._renderNoDataMessage();}}var _36=this.model.get("data");this._set("value",_36);if(!this.readOnly){this.onChange(_36);}},_renderNoDataMessage:function(){if(this.grid.noDataNode){return;}this.grid.noDataNode=put(this.grid.contentNode,"div.dgrid-no-data");this.grid.noDataNode.innerHTML=this.grid.noDataMessage;}});});