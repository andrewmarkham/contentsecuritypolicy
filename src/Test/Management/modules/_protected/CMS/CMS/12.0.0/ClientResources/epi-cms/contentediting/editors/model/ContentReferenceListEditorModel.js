//>>built
define("epi-cms/contentediting/editors/model/ContentReferenceListEditorModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/store/Memory","dojo/store/Observable","dojo/when","dojo/topic","epi/datetime","epi/dependency","epi/shell/command/_CommandProviderMixin","epi/shell/command/DelegateCommand","epi-cms/component/command/ChangeContext","epi-cms/contentediting/ContentActionSupport","epi-cms/contentediting/viewmodel/_ViewModelMixin","epi/i18n!epi/cms/nls/episerver.cms.widget.contentlist","epi/i18n!epi/nls/episerver.shared"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _2([_e,_a],{res:_f,store:null,valueStore:null,contentLinks:null,query:null,readOnly:false,postscript:function(){this.inherited(arguments);this._contentLinkCountMap={};this.query={query:{},queryOptions:{sort:[{attribute:"index"}]}};this.store=this.store||_9.resolve("epi.storeregistry").get("epi.cms.content.light");this.valueStore=this.valueStore||new _5(new _4());this._createCommands();},_convertContentDataToListItems:function(_11){return _11.map(function(_12,_13){return _3.mixin({id:this._getUniqueId(_12.contentLink),index:_13,userName:_12.changedBy,modified:_12.saved,contentLanguage:_12.currentLanguageBranch?_12.currentLanguageBranch.languageId:null,delayPublishUntil:_12.status===_d.versionStatus.DelayedPublish?_12.startPublish:null},_12);},this);},_getUniqueId:function(_14){var _15=this._contentLinkCountMap[_14];if(!_15){_15=0;}this._contentLinkCountMap[_14]=_15+1;return _14+"_"+_15;},_contentLinksGetter:function(){return this.valueStore.query(this.query.query,this.query.queryOptions).map(function(_16){return _16.contentLink;});},setContentLinks:function(_17){return this._getDetailedValue(_17).then(_3.hitch(this,function(_18){this._contentLinkCountMap={};var _19=this._convertContentDataToListItems(_18);this.valueStore.setData(_19);this.contentLinks=_17;}));},addItems:function(_1a,_1b,_1c){if(!_1a){return;}var _1d;if(typeof _1b!=="number"){_1d=this.valueStore.data.length;}else{_1d=_1c?_1b:_1b+1;}var _1e=this._convertContentDataToListItems(_1a);var _1f=this._getAllItemsInCorrectOrder(_1e,_1d);this._updateIndexOnItems(_1f);return _1e;},moveItems:function(_20,_21,_22){if(typeof _21!="number"){return;}var _23=_22?_21:_21+1;var _24=_20.map(function(id){return this.valueStore.get(id);},this);_24.sort(function(_25,_26){return _25.index-_26.index;});var _27=this._getAllItemsInCorrectOrder(_24,_23);this._updateIndexOnItems(_27);},removeItems:function(_28){if(!_28){return;}_28.forEach(_3.hitch(this,function(id){this.valueStore.remove(id);}));var _29=this.valueStore.query(this.query.query,this.query.queryOptions);this._updateIndexOnItems(_29);},_getAllItemsInCorrectOrder:function(_2a,_2b){var _2c=_2a.map(function(_2d){return _2d.id;});var _2e=this.valueStore.query(function(_2f){var _30=_2c.indexOf(_2f.id)>=0;return !_30&&_2f.index>=_2b;},this.query.queryOptions);var _31=this.valueStore.query(function(_32){var _33=_2c.indexOf(_32.id)>=0;return !_33&&_32.index<_2b;},this.query.queryOptions);return _31.concat(_2a).concat(_2e);},_updateIndexOnItems:function(_34){_34.forEach(function(_35,_36){_35.index=_36;this.valueStore.put(_35);},this);},addContentLink:function(_37){return this._getDetailedValue([_37]).then(_3.hitch(this,function(_38){return this.addItems(_38);}));},_getDetailedValue:function(_39){if(!_39||!_39.length){return _6([]);}return _6(this._getDetails(_39)).then(_3.hitch(this,function(_3a){return this._mapDetails(_39,_3a);}));},_mapDetails:function(_3b,_3c){var _3d={};if(_3c){_1.forEach(_3c,function(_3e){if(_3e&&_3e.contentLink){_3d[_3e.contentLink]=_3e;}});return _1.map(_3b,function(_3f){return _3d[_3f]||this._getDefaultContentModel(_3f);},this);}},_getDefaultContentModel:function(_40){return {name:this.res.contentnotfound,accessMask:1,contentLink:_40,saved:_8.transformDate(new Date(0))};},_getDetails:function(_41){return this.store.executeMethod("List",null,_41);},_createCommands:function(){var _42=this;this.add("commands",new _c({category:"menuWithSeparator"}));this.add("commands",new _b({name:"moveUp",category:"itemContext",label:_10.action.moveup,iconClass:"epi-iconUp",isAvailable:true,delegate:_3.hitch(this,this.moveItemUpDelegate),_onModelChange:function(){if(this.model.ids.length!==1){this.set("canExecute",false);return;}var id=this.model.ids[0];var _43=_42.valueStore.get(id);this.set("canExecute",_43.index!==0&&!_42.get("readOnly"));}}));this.add("commands",new _b({name:"moveDown",category:"menuWithSeparator",label:_10.action.movedown,iconClass:"epi-iconDown",isAvailable:true,delegate:_3.hitch(this,this.moveItemDownDelegate),_onModelChange:function(){if(this.model.ids.length!==1){this.set("canExecute",false);return;}var id=this.model.ids[0];var _44=_42.valueStore.get(id);var _45=_42.valueStore.data.length-1;this.set("canExecute",_44.index!==_45&&!_42.get("readOnly"));}}));this.add("commands",new _b({name:"remove",category:"itemContext",label:_10.action.remove,iconClass:"epi-iconTrash",_onModelChange:function(){this.set("canExecute",!_42.get("readOnly"));},isAvailable:true,delegate:_3.hitch(this,this.removeItemDelegate)}));},removeItemDelegate:function(cmd){if(!cmd||!cmd.model){return;}this.removeItems(cmd.model.ids);},moveItemUpDelegate:function(cmd){if(!cmd||!cmd.model){return;}var _46=cmd.model.ids[0];var _47=this.valueStore.get(_46).index;this.moveItems([_46],_47-1,true);},moveItemDownDelegate:function(cmd){if(!cmd||!cmd.model){return;}var _48=cmd.model.ids[0];var _49=this.valueStore.get(_48).index;this.moveItems([_48],_49+1,false);},navigateToItem:function(_4a){if(!_d.hasAccess(_4a.accessMask,_d.accessLevel.Read)){return;}var uri="epi.cms.contentdata:///"+_4a.contentLink;_7.publish("/epi/shell/context/request",{uri:uri},{sender:this});},updateCommandModel:function(_4b){_1.forEach(this.commands,function(_4c){if(_4c.isInstanceOf(_c)){if(_4b.ids.length===1){var _4d=_4b.ids[0];_4c.set("model",this.valueStore.get(_4d));}else{_4c.set("model",null);}}else{_4c.set("model",_4b);}},this);}});});