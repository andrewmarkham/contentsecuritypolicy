//>>built
define("epi-cms/project/viewmodels/ProjectModeToolbarViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/Evented","dojo/Stateful","dojo/topic","dojo/when","dijit/Destroyable","epi/shell/command/_CommandProviderMixin","epi/epi","epi/dependency","epi-cms/_ContentContextMixin","../command/AddProject","../command/RenameProject","../command/RemoveProject","epi/shell/xhr/errorHandler"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _1([_6,_9,_5,_d,_a],{projectStore:null,currentProject:null,overviewButtonVisible:false,postscript:function(){this.inherited(arguments);this.projectService=this.projectService||_c.resolve("epi.cms.ProjectService");this.projectStore=this.projectStore||_c.resolve("epi.storeregistry").get("epi.cms.project");this._createCommands();var _12=function(id){if(this.currentProject&&this.currentProject.id===id){this._markCurentProjectAsDeleted();}}.bind(this);var _13=function(_14){if(this.currentProject&&this.currentProject.id===_14.id){this.set("currentProject",_14);}}.bind(this);this.own(this.projectService.on("project-removed",_12),this.projectService.on("project-updated",_13));_8(this.getCurrentContext()).then(this.contextChanged.bind(this));},initialize:function(){return _8(this.projectService.getCurrentProject()).then(_2.hitch(this,function(_15){this._changeAttrValue("currentProject",_15,false);this.set("overviewButtonVisible",!!_15);}));},contentContextChanged:function(_16,_17){this.inherited(arguments);if(this.get("currentProject")){var _18=this;this.projectService.exists(this.currentProject.id).then(function(_19){if(!_19){_18.emit("currentProjectDoesNotExists");}});}},_markCurentProjectAsDeleted:function(){var _1a=_2.clone(this.currentProject);_1a.isDeleted=true;this.set("currentProject",_1a,false);this.set("overviewButtonVisible",false);},contextChanged:function(_1b,_1c){this.inherited(arguments);if(_1b&&_1b.type==="epi.cms.project"){var _1d=parseInt(_1b.id,10);_8(this.projectStore.get(_1d)).then(_2.hitch(this,function(_1e){if(_1c&&_1c.sender&&_1c.sender._requestContext){this.emit("animateToolbar");}this.set("currentProject",_1e);}));}},_currentProjectSetter:function(_1f,_20){if(_b.areEqual(this._clearProjectStats(this.currentProject),this._clearProjectStats(_1f))){return;}this.set("overviewButtonVisible",!!_1f);this.currentProject=_1f;var _21=new _4().resolve();if(_20||_20===undefined){_21=this.projectService.setCurrentProject(_1f);}_21.then(_2.hitch(this,"getCurrentContext")).then(function(_22){if(_22.type!=="epi.cms.project"&&_22.currentMode===undefined){_7.publish("/epi/shell/context/request",{uri:_22.versionAgnosticUri},{sender:this});}});},_clearProjectStats:function(_23){if(!_23){return _23;}return Object.assign({},_23,{itemStatusCount:{}});},showProjectOverview:function(_24){var _25="epi.cms.project:///"+_24;_7.publish("/epi/shell/context/request",{uri:_25},{sender:this});},getCommands:function(){return this.commands;},addProject:function(_26){this.projectStore.add(_26).then(_2.hitch(this,function(_27){this.set("currentProject",_27);})).otherwise(_11.forXhr);},getProject:function(){return this.get("currentProject");},updateProject:function(_28){this.projectStore.put(_28).then(_2.hitch(this,"set","currentProject")).otherwise(_11.forXhr);},reactivateProject:function(){if(!this.currentProject){return new _4().resolve();}return this.projectService.reactivateProject(this.currentProject.id);},removeProject:function(){if(!this.currentProject){return new _4().resolve();}return this.projectStore.remove(this.currentProject.id).then(_2.hitch(this,function(){this.set("currentProject",null);}));},_createCommands:function(){var _29={model:this,category:"context",propertiesToWatch:["currentProject"]},_2a=this.own(new _e(_29),new _f(_29),new _10(_29));this.set("commands",_2a);}});});