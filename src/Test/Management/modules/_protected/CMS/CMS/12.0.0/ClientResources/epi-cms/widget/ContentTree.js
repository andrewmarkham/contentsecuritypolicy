//>>built
define("epi-cms/widget/ContentTree",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-style","dojo/aspect","dojo/Deferred","dojo/Evented","dojo/keys","dojo/promise/all","dojo/query","dojo/sniff","dojo/when","dijit/registry","epi/dependency","epi/shell/DestroyableByKey","epi/shell/dnd/tree/dndSource","epi/shell/TypeDescriptorManager","epi/shell/widget/Tree","epi-cms/core/ContentReference","epi-cms/dgrid/formatters","epi-cms/widget/_ContentTreeNode","epi-cms/widget/ContentTreeModelConfirmation","epi-cms/widget/ContentForestStoreModel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19){return _3([_14,_9,_11],{roots:null,expandExtraNodeItems:null,nodeConstructor:null,typeIdentifiers:null,allowManipulation:true,persist:false,expandOnDnd:true,showRoot:false,handleSelection:false,disableRestrictedTypes:false,dndSource:null,postMixInProperties:function(){this.inherited(arguments);if(!this.model){this.model=this._createTreeModel();}this.own(this.model);if(this.allowManipulation){this.dndController=this.dndSource||_12;this.accept=this.model.containedTypes||this.containedTypes;}this.checkItemAcceptance=_4.hitch(this,this.checkItemAcceptance);this.nodeConstructor=this.nodeConstructor||_17;this.own(_7.around(this.model,"pasteItems",this._aroundPasteItem.bind(this)));if(this.allowedTypes){var _1a=_1.some(this.allowedTypes,function(_1b){return _1b==="episerver.core.contentfolder";});if(!_1a){this.allowedTypes.push("episerver.core.contentfolder");}}},getItemType:function(_1c){return _13.getAndConcatenateValues(_1c.typeIdentifier,"dndTypes");},buildRendering:function(){this.model=this._wrapModel(this.model);this.inherited(arguments);},_wrapModel:function(_1d){return _18(this.model);},postCreate:function(){this.inherited(arguments);this.own(this.connect(this.model,"onSelect",_4.hitch(this,this._onSelect)),_7.before(this.model,"onToggleContentDisplay",_4.hitch(this,function(_1e,_1f){var _20=this.getNodesByItem(_1e)[0];if(_20){_6.set(_20.domNode,{display:_1f===true?"":"none"});}})));},onLoad:function(){this.inherited(arguments);return _e(this._expandRootNodes(),_4.hitch(this,this._expandExtraNodes));},_expandRootNodes:function(){var _21=this.showRoot?[this.rootNode]:this.rootNode.getChildren();return _b(_1.map(_21,this.tree._expandNode,this));},_expandExtraNodes:function(){if(!this.expandExtraNodeItems){return;}var _22=this.expandExtraNodeItems instanceof Array?this.expandExtraNodeItems:[this.expandExtraNodeItems];var _23=_1.map(_22,function(_24){return this.tree.getNodesByItem(_24)[0];},this);_23=_1.filter(_23,Boolean);return _b(_1.map(_23,this.tree._expandNode,this));},_aroundPasteItem:function(_25){return function(_26,_27){if(_27.isWastebasket){return _25.apply(this.model,arguments);}var _28=this.get("selectedNode");if(!_28){return _25.apply(this.model,arguments);}_28.markProcessing();return _25.apply(this.model,arguments).then(function(){if(!_28.isExpanded){_28.expand();}}).always(function(){_28.unmarkProcessing();});}.bind(this);},checkItemAcceptance:function(_29,_2a,_2b){var _2c=_f.getEnclosingWidget(_29),_2d=_2c&&_2c.item;if(!_2d){return false;}return this.model.checkItemAcceptance(_2d,_2a);},_setAllowManipulationAttr:function(_2e){this._set("allowManipulation",_2e);if(_2e){this.dndController=this.dndSource||_12;}},_createTreeModel:function(){return new _19({roots:this.roots,typeIdentifiers:this.typeIdentifiers});},_onItemDelete:function(_2f,_30){function _31(_32,_33){_1.forEach(_32.getChildren(),function(_34){_33.push(_34.item);_31(_34,_33);});return _33;};if(_30){var _35=this._itemNodesMap[this.model.getIdentity(_2f)];if(_35){_1.forEach(_35,function(_36){_1.forEach(_31(_36,[]).reverse(),function(_37){this._onItemDelete(_37);},this);},this);}}this.inherited(arguments);},_setTypeIdentifiersAttr:function(_38){this._set("typeIdentifiers",_38);if(this.model){this.model.typeIdentifiers=_38;}},getTooltip:function(_39){var _3a=this.model.getTooltip||this.model.getLabel;var _3b=new _15(_39.contentLink),_3c=_3a?_3a(_39):this.inherited(arguments);return _3c?_16.title(_3c,_3b.id,_39.contentTypeName):_3c;},buildNodeFromTemplate:function(_3d){return new this.nodeConstructor(_3d);},_createTreeNode:function(_3e){var _3f=_4.mixin({},_3e,{dndData:_3e.item});return this.buildNodeFromTemplate(_3f);},getIconClass:function(_40,_41){if(!_40){return this.inherited(arguments);}var _42=_13.getValue(_40.typeIdentifier,"iconClass");if(this.model.isTypeOfRoot(_40)){return this.model.getObjectIconClass(_40,_42);}var _43=_13.getValue(_40.typeIdentifier,"supportsOpenCssClass");if(_41&&!_40.isSubRoot&&_43){_42=_42+"Open";}return _42+this._getItemDisableStyle(_40);},getLabelClass:function(_44,_45){return this._getItemDisableStyle(_44);},focus:function(){this.focusNode(this.get("selectedNode")||this.rootNode);},_getItemDisableStyle:function(_46){if(this.disableRestrictedTypes){return this._isItemRestricted(_46)?" is-disabled ":"";}return "";},_isItemRestricted:function(_47){var _48=_13.getValidAcceptedTypes([_47.typeIdentifier],this.allowedTypes,this.restrictedTypes);return !_48.length;},_getTargetPath:function(_49){var _4a=this.model,_4b=new _8();_4a.getAncestors(_49,function(_4c){_4c.push(_49);var _4d=_1.map(_4c,function(_4e){return _4a.getIdentity(_4e).toString();});if(typeof _4a.filterAncestors==="function"){_4d=_4a.filterAncestors(_4d);}_4b.resolve(_4d);});return _4b.promise;},_isValidTargetContent:function(_4f){if(!_4f){return false;}return !_4f.isDeleted&&!_4f.isWastebasket;},_onSelect:function(id,_50,_51){var _52=this.get("selectedNode");this.tree.model.set("previousContextualSelection",{selectedContent:_52});this.selectContent(id,_50,true,_51).then(_4.hitch(this,function(){_52=this.get("selectedNode");if(_52&&_52.item&&_52.item.contentLink){this.emit("select",_52.item,_52);}}));},selectContent:function(_53,_54,_55,_56){var _57=this,_58=_57.model,_59=new _8(),_5a=function(_5b){_57._preparePathNodes(_5b);_57._setRecursivePaths(_5b,_59,_54,_56);};_e(_58.store.get(_53),function(_5c){if(!_57._isValidTargetContent(_5c)){_57.set("paths",[]);_59.resolve(null);}else{_57._getTargetPath(_5c).then(function(_5d){_57._onSetTargetPath();_5a(_5d);});}});return _59.promise;},_onSetTargetPath:function(){if(!this.handleSelection){return;}var _5e=this.get("selectedNode");if(_5e){_5e=this.getNodesByItem(_5e.item)[0];if(_5e){this.model.set("previousSelection",{selectedContent:_5e,selectedAncestors:_5e.getTreePath()});}}},_preparePathNodes:function(_5f){},_setRecursivePaths:function(_60,_61,_62,_63){if(!_60||_60.length===0){return;}this.set("paths",[_60]).then(_4.hitch(this,function(){var _64=this.get("selectedNode");if(!_64){this._setRecursivePaths(_60.slice(0,-1),_61,_62,_63);return;}if(_62){this.focus();}if(_63){_63(_64);}_61.resolve(_64);},_61.reject));},_onKeyDown:function(_65,e){this.inherited(arguments);if(!this.allowManipulation){return;}if(_2.isCopyKey(e)){var _66=e.keyCode?String.fromCharCode(e.keyCode).toLowerCase():"";switch(_66){case "c":this.emit("copyOrCut",true);break;case "x":this.emit("copyOrCut",false);break;case "v":this.emit("paste");break;default:break;}}if(e.altKey||e.ctrlKey||e.metaKey){return;}if(e.shiftKey&&e.keyCode===_a.F10){this.emit("showContextMenu",e);e.preventDefault();return;}if(e.shiftKey){return;}if(e.keyCode===_a.DELETE){this.emit("delete");}},_onNodeMouseLeave:function(_67,evt){this.inherited(arguments);if(_d("ie")){_1.forEach(_c(".dijitTreeRow.dijitTreeRowHover",this.tree.domNode),function(_68){_5.remove(_68,"dijitTreeRowHover");});}}});});