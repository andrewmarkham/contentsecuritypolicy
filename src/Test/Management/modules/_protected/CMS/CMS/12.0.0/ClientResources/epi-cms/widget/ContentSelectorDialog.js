//>>built
define("epi-cms/widget/ContentSelectorDialog",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-geometry","dojo/when","dijit/layout/_LayoutWidget","epi","epi/shell/TypeDescriptorManager","epi-cms/ApplicationSettings","epi-cms/widget/ContentTree","epi-cms/widget/ContextualContentForestStoreModel","epi-cms/widget/SearchBox","epi/shell/widget/_ActionProviderWidget","epi/dependency","epi/i18n!epi/cms/nls/episerver.cms.widget.contentselectordialog"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return _2([_6,_d],{_contentRef:null,res:_f,baseClass:"epi-content-selector-dialog",roots:null,typeIdentifiers:null,showButtons:true,model:null,allowedTypes:null,restrictedTypes:null,canSelectOwnerContent:true,multiRootsMode:false,_typesToDisplay:null,showAllLanguages:false,selectedContentType:null,showSearchBox:true,searchArea:null,_searchBox:null,buildRendering:function(){this.inherited(arguments);var _10=this._getTypesToDisplay(),_11=this.model,_12=this.roots||(_11&&_11.roots);this.preventContextualContentFor=this.preventContextualContentFor||this._getSettingFromContentType();if(!_11||this.showContextualContent){_11=new _b({roots:_12,typeIdentifiers:_10,notSupportContextualContents:this.preventContextualContentFor,showAllLanguages:this.showAllLanguages});}_11.set("view","contentselector");if(this.showSearchBox&&this.searchArea){this._searchBox=new _c({innerSearchBoxClass:"epi-search--full-width",triggerContextChange:false,parameters:{allowedTypes:this.allowedTypes,restrictedTypes:this.restrictedTypes},onItemAction:_3.hitch(this,function(_13){if(_13&&_13.metadata&&this._checkAcceptance(_13.metadata.typeIdentifier)){this.set("value",_13.metadata.id);this.onChange(_13.metadata.id);}})});this._searchBox.set("area",this.searchArea);this._searchBox.set("searchRoots",this.roots);var _14=this._searchBox;_11.getRoots(true).then(function(_15){_14.set("searchRoots",_15.join(","));});this.addChild(this._searchBox);}this.tree=new _a({roots:_12,typeIdentifiers:_10,allowManipulation:false,model:_11,allowedTypes:_3.clone(this.allowedTypes),restrictedTypes:_3.clone(this.restrictedTypes),disableRestrictedTypes:true,expandExtraNodeItems:_9.startPage});this.addChild(this.tree);this.connect(this.tree,"onClick","_onTreeNodeClick");},layout:function(){this.inherited(arguments);var _16=this._contentBox.h;if(this._searchBox){_16-=_4.getMarginBox(this._searchBox.domNode).h;}var _17=_4.getMarginBox(this.tree.domNode);_17.h=_16;_4.setMarginBox(this.tree.domNode,_17);},_getSettingFromContentType:function(){if(!this.selectedContentType){return null;}var _18=this.contentRepositoryDescriptors||_e.resolve("epi.cms.contentRepositoryDescriptors");var _19,_1a=function(_1b){return _8.isBaseTypeIdentifier(this.selectedContentType,_1b);};for(var _1c in _18){var _1d=_18[_1c];if(_1.some(_1d.containedTypes,_1a,this)){_19=_1d;break;}}return _19.preventContextualContentFor;},_getTypesToDisplay:function(){if(!this._typesToDisplay){var _1e=[];this._getContainerTypesRecursive(this.allowedTypes,_1e);this._typesToDisplay=_1e;}return this._typesToDisplay;},_getContainerTypesRecursive:function(_1f,_20,_21){if(!_21){_21=[];}_1.forEach(_1f,_3.hitch(this,function(_22){if(_1.indexOf(_21,_22)===-1){_21.push(_22);if(_1.indexOf(_20,_22)===-1){_20.push(_22);}var _23=_8.getValue(_22,"containerTypes");if(_23){this._getContainerTypesRecursive(_23,_20,_21);}}}));},_setValueAttr:function(_24){if(_24){this._contentRef=_24;var _25=this._contentRef==="-"?null:this._contentRef;if(this.multiRootsMode){_5(this.tree.onLoadDeferred,_3.hitch(this,function(){this.tree.selectContent(_25,true);}));}else{if(!_7.isEmpty(_25)){this.tree.selectContent(_25,true);}}}else{this._contentRef=null;this._clearSelectedContent();}},_getValueAttr:function(){this.inherited(arguments);if(this._contentRef){return this._contentRef.toString();}else{return "";}},_setAllowedTypesAttr:function(_26){this._typesToDisplay=null;this._set("allowedTypes",_26);},_clearSelectedContent:function(){this.tree.set("selectedNodes",[]);this.tree.set("selectedItems",[]);},getActions:function(){return this.canSelectOwnerContent?[{name:"selectpage",label:_f.currentpage,settings:{type:"submit"},action:_3.hitch(this,function(){this._setValueOwnerContent();})}]:[];},_onTreeNodeClick:function(_27){var _28=_27.contentLink;if(!this._checkAcceptance(_27.typeIdentifier)){this.tree.lastFocused.setSelected(false);_28=null;}this.set("value",_28);this.onChange(this.get("value"));},_checkAcceptance:function(_29){var _2a=_8.getValidAcceptedTypes([_29],this.allowedTypes,this.restrictedTypes);return !!_2a.length;},_setValueOwnerContent:function(){this.set("value","-");},onChange:function(_2b){},focus:function(){this.tree.focus();}});});