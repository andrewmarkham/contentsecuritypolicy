//>>built
define("epi-cms/widget/ContentSelector",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-style","dojo/dom-construct","dojo/string","dojo/when","dijit/focus","dijit/form/Button","epi/dependency","epi/shell/TypeDescriptorManager","epi/shell/widget/dialog/Dialog","epi-cms/core/ContentReference","epi-cms/contentediting/ContentActionSupport","epi-cms/widget/ContentSelectorDialog","epi-cms/widget/_SelectorBase","epi/i18n!epi/cms/nls/episerver.cms.widget.contentselector"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12){return _2([_11],{roots:null,value:null,required:false,missingMessage:_12.requiredmessage,tooltipPosition:[],contentLink:null,previewUrl:null,canSelectOwnerContent:false,accessLevel:_f.accessLevel.Read,showAllLanguages:true,showSearchBox:true,searchArea:null,contentClass:null,dialogClass:"epi-dialog-portrait",_setDisabledAttr:function(_13){this.inherited(arguments);this.button.set("disabled",_13);this._set("disabled",_13);},buildRendering:function(){var _14=this.name?(this.name.replace(/"/g,"&quot;")):"";this.input=_6.create("input",{type:"hidden",name:_14});this.inherited(arguments);this.domNode.appendChild(this.input);},postMixInProperties:function(){this.inherited(arguments);var _15=_b.resolve("epi.storeregistry");this._store=_15.get("epi.cms.content.light");var _16=this.contentRepositoryDescriptors||_b.resolve("epi.cms.contentRepositoryDescriptors");var _17=_16.get(this.repositoryKey);if(_17&&!this.roots){this.roots=_17.roots;}if(_17&&!this.searchArea){this.searchArea=_17.searchArea;}},postCreate:function(){this.inherited(arguments);if(!this.value){this._updateDisplayNode(null);}},destroy:function(){if(this.dialog){this.dialog.destroy();}this.inherited(arguments);},_setReadOnlyAttr:function(_18){this._set("readOnly",_18);_5.set(this.button.domNode,"display",_18?"none":"");_5.set(this.clearButton,"display",_18?"none":"");_4.toggle(this.domNode,"dijitReadOnly",_18);},_setValueAttr:function(_19){this._setValueAndFireOnChange(_19);},createDialogContent:function(){return new _10({canSelectOwnerContent:this.canSelectOwnerContent,showButtons:false,roots:this.roots,allowedTypes:this.allowedTypes,restrictedTypes:this.restrictedTypes,showAllLanguages:this.showAllLanguages,showSearchBox:this.showSearchBox,searchArea:this.searchArea});},_getDialog:function(){if(this.dialog&&this.dialog.domNode){return this.dialog;}var _1a=_12.title;if(this.allowedTypes&&this.allowedTypes.length===1){var _1b=_c.getResourceValue(this.allowedTypes[0],"name");if(_1b){_1a=_7.substitute(_12.format,[_1b]);}}this.contentSelectorDialog=this.createDialogContent();this.dialog=new _d({title:_1a,dialogClass:this.dialogClass,contentClass:this.contentClass,content:this.contentSelectorDialog,destroyOnHide:false});this.dialog.own(this.contentSelectorDialog);this.connect(this.contentSelectorDialog,"onChange","_setDialogButtonState");this.connect(this.dialog,"onExecute","_onDialogExecute");this.connect(this.dialog,"onHide","_onDialogHide");this.connect(this.dialog,"onShow","_onDialogShow");return this.dialog;},_onDialogShow:function(){this.inherited(arguments);this._setDialogButtonState(this._convertValueToContentReference(this.value));},_isContentAllowed:function(_1c){var _1d=_c.getValidAcceptedTypes([_1c],this.allowedTypes,this.restrictedTypes);return !!_1d.length;},_onButtonClick:function(){_8(this._getContentData(this.contentLink),_3.hitch(this,function(_1e){this.canSelectOwnerContent=this.canSelectOwnerContent&&_1e&&this._isContentAllowed(_1e.typeIdentifier);var _1f=this._getDialog();this.isShowingChildDialog=true;var _20;if(this.value){_20=this._convertValueToContentReference(this.value);}if(_20){_20=_20.createVersionUnspecificReference().toString();this.contentSelectorDialog.set("value",_20);}else{this.setInitialValue();}_1f.show();}));},setInitialValue:function(){this.contentSelectorDialog.set("value",undefined);},_onDialogExecute:function(){var _21=this.contentSelectorDialog.get("value");this._setValueAndFireOnChange(_21);},_convertValueToContentReference:function(_22){return _22?new _e(_22):null;},_setValueAndFireOnChange:function(_23){var _24=_23==="-"?this.contentLink:_23;this.set("permanentLink",null);this.set("previewUrl",null);this._valueChangedPromise=_8(this._getContentData(_24),_3.hitch(this,function(_25){if(this._destroyed){return;}this._valueChangedPromise=null;var _26=this.value!==_24;this.value=_24;this.input.value=this.value;this._started&&this.validate();this._updateDisplayNode(_25);if(_26){this.onChange(_24);}if(_25){this.set("permanentLink",_25.permanentLink);this.set("previewUrl",_25.previewUrl);}}));},_getContentData:function(_27){if(!_27){return null;}return this._store.get(_27);},_onFocus:function(){if(this.get("disabled")){return;}this.inherited(arguments);this.validate();},_onBlur:function(){if(this.get("disabled")){return;}this.inherited(arguments);this.validate();},focus:function(){if(!this.button.disabled&&this.button.focusNode&&this.button.focusNode.focus){try{_9.focus(this.button.focusNode);}catch(e){}}},_updateDisplayNode:function(_28){this.inherited(arguments);if(_28){this.set("selectedContentLink",new _e(_28.contentLink).id);}else{this.set("selectedContentName",_12.helptext);this.set("selectedContentLink","");}},reset:function(){this.set("value",null);},_setDialogButtonState:function(_29){var _2a=this;if(!_29){_2a.dialog.definitionConsumer.setItemProperty(_2a.dialog._okButtonName,"disabled",true);return;}_8(_2a._store.get(_29),function(_2b){_2a.dialog.definitionConsumer.setItemProperty(_2a.dialog._okButtonName,"disabled",!_f.hasAccess(_2b.accessMask,_2a.accessLevel));});}});});