//>>built
define("epi-cms/contentediting/InUseNotificationManager",["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/when","dojo/date","dojo/aspect","epi","epi/username","epi/dependency","epi-cms/ApplicationSettings","epi-cms/core/ContentReference","epi/i18n!epi/cms/nls/episerver.cms.contentediting.permanenteditindication"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _3([],{contextTypeName:"",_postFlag:false,_inUseNotificationStore:null,_currentUsername:null,_messageService:null,currentModel:null,_eventHandlers:null,ignoreOthersNotifications:null,constructor:function(_d){this.inherited(arguments);_1.mixin(this,_d);this._inUseNotificationStore=this.store||_9.resolve("epi.storeregistry").get("epi.cms.inusenotification");this._currentUsername=this.username||_a.userName;this._messageService=this.messageService||_9.resolve("epi.shell.MessageService");this._eventHandlers=[];},updateCommandModel:function(_e){this.inherited(arguments);if(this.currentModel&&!_b.compareIgnoreVersion(this.currentModel.contentData.contentLink,_e.contentData.contentLink)){this.ignoreOthersNotifications=false;}this.currentModel=_e;_2.forEach(this._eventHandlers,function(_f){_f.remove();});this.updateMessageService(this.currentModel.contentData);this._eventHandlers=[_6.after(_e,"suspend",_1.hitch(this,this._onViewModelSuspended)),_6.after(_e,"destroyed",_1.hitch(this,this._onViewModelSuspended)),_6.after(_e,"onPropertyEdited",_1.hitch(this,this._onPropertyEdited)),_6.around(_e,"canChangeContent",_1.hitch(this,this._canChangeContentAdvisor))];},_canChangeContentAdvisor:function(_10){return _1.hitch(this,function(){if(!this.ignoreOthersNotifications){var _11=this.getOtherUsersInUseNotifications(this.currentModel.contentData.inUseNotifications);if(_11&&_11.length){return false;}}return _10.apply(this.currentModel,arguments);});},_onViewModelSuspended:function(){var _12=this.currentModel.contentData;this.removeAutomaticInUseNotification(_12);},_onPropertyEdited:function(){var _13=this.currentModel.contentData;this.ensureAutomaticInUseNotification(_13);},ensureAutomaticInUseNotification:function(_14){var _15;_2.some(_14.inUseNotifications,function(_16){if(_16.userName.toLowerCase()===this._currentUsername.toLowerCase()){_15=_16;return true;}},this);if(!_15){return this.put(this._createNotification(_14,false),_14.inUseNotifications);}else{if(_15.addedManually){return;}else{var _17=new Date(_15.modified);if(_5.difference(_17,new Date(),"minute")>30){return this.put(_15,_14.inUseNotifications);}}}},removeAutomaticInUseNotification:function(_18){_2.forEach(_18.inUseNotifications,function(_19){if(_19.userName.toLowerCase()===this._currentUsername.toLowerCase()&&!_19.addedManually){this.remove(_19,_18.inUseNotifications);}},this);},_createNotification:function(_1a,_1b){var _1c=(new Date()).toISOString();return {contentLink:_1a.contentLink,languageBranch:_1a.currentLanguageBranch&&_1a.currentLanguageBranch.languageId,addedManually:_1b,created:_1c,modified:_1c};},put:function(_1d,_1e){_1d.modified=(new Date()).toISOString();if(!this._postFlag){this._postFlag=true;return _4(this._inUseNotificationStore.put(_1d),_1.hitch(this,function(_1f){var _20;var _21=_2.some(_1e,function(_22,_23){if(_1f.id===_22.id){_20=_23;return true;}return false;});if(_21&&_20>=0){_1e[_20]=_1f;}else{_1e.push(_1f);}this._updateDependentStores(_1d.contentLink,_1e);this._postFlag=false;}));}},remove:function(_24,_25){return _4(this._inUseNotificationStore.remove(_24.id),_1.hitch(this,function(){var _26=_2.indexOf(_25,_24);_25.splice(_26,1);this._updateDependentStores(_24.contentLink,_25);}));},_updateDependentStores:function(_27,_28){var _29={contentLink:_27,inUseNotifications:_28};this._inUseNotificationStore.updateDependentStores(_29);},togglePermanentEditIndication:function(_2a,_2b){var _2c;var _2d=_2.some(_2a.inUseNotifications,function(_2e){if(_2e.userName.toLowerCase()===this._currentUsername.toLowerCase()){_2c=_2e;if(_2e.addedManually){return true;}}},this);if(_2d){if(_2b&&_2c.convertedFromAutomaticNotification){_2c.addedManually=false;return this.put(_2c,_2a.inUseNotifications);}else{return this.remove(_2c,_2a.inUseNotifications);}}else{if(_2c&&_2b){_2c.convertedFromAutomaticNotification=true;_2c.addedManually=true;}else{_2c=this._createNotification(_2a,true);}return this.put(_2c,_2a.inUseNotifications);}},updateMessageService:function(_2f){var _30=_2f.contentLink+"_permanentEdit";this._messageService.remove({externalItemId:_30});var _31=this._getManualInUseNotification(_2f.inUseNotifications);if(_31){this._notificationHandlerId=this._messageService.put("note",_c.permanenteditison,this.contextTypeName,_2f.contentLink,_30,null);}},_getManualInUseNotification:function(_32){var _33;_2.forEach(_32,function(_34){if(_34.userName.toLowerCase()===this._currentUsername.toLowerCase()&&_34.addedManually){_33=_34;}},this);return _33;},currentUserHasInUseNotification:function(_35,_36){return _2.some(_35,function(_37){return _37.userName.toLowerCase()===this._currentUsername.toLowerCase()&&(!_36||_37.addedManually);},this);},getOtherUsersInUseNotifications:function(_38){var _39=[];_2.forEach(_38,function(_3a){if(_3a.userName.toLowerCase()!==this._currentUsername.toLowerCase()){var _3b=_8.toUserFriendlyString(_3a.userName,this._currentUsername);_39.push(_3b);}},this);return _39;},hasInUseNotificationWarning:function(_3c){if(this.ignoreOthersNotifications){return false;}return this.getOtherUsersInUseNotifications(_3c).length;}});});