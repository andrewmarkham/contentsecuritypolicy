//>>built
define("epi-cms/contentediting/OnPageEditing",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/on","dojo/when","dojo/topic","epi/shell/gesture/ScrollPullDown","epi-cms/contentediting/_FormEditingMixin","epi-cms/contentediting/_ValidationMixin","epi-cms/contentediting/EditingBase"],function(_1,_2,_3,on,_4,_5,_6,_7,_8,_9){return _1([_9,_7,_8],{_iframeConnects:null,postMixInProperties:function(){this.inherited(arguments);this.formSettings={doLayout:false,baseClass:"epi-cmsEditingForm epi-cmsEditingFormOpe",propertyFilter:function(_a,_b){return _b.groupName==="EPiServerCMS_SettingsPanel";}};},destroy:function(){this._removePullDownGesture();this.inherited(arguments);},onEditorWrapperCreated:function(_c){if(_c&&_c.editorWidget){var _d=_c.editorWidget;if(_d.onFieldCreated){var _e=_3.after(_d,"onFieldCreated",_2.hitch(this,function(_f,_10){_e.remove();_e=null;this._addStateWatch(_10);}),true);}else{_d.set("name",_c.get("propertyName"));this._addStateWatch(_d);}_d.validate&&_d.validate();}},onSetActiveProperty:function(_11){var _12=this._mappingManager.findOne("propertyName",_11);if(!_12){_5.publish("/epi/cms/action/switcheditmode",null,{activePropertyOnStartup:_11});}else{if(_12.wrapper){_12.wrapper.startEdit();}else{if(_12.overlayItem){this._onOverlayItemClick(_12.overlayItem);}}}},_onOverlayItemClick:function(_13,e){var _14=this._activeEditorWrapper;var _15=this._mappingManager.find().filter(function(_16){return (_16.overlayItem&&_16.wrapper);}).map(function(_17){return _17.wrapper;});if(_15.length>0){_15.forEach(function(_18){_18.tryToStopEditing();});var _19=_15.some(function(_1a){return (_1a.editing);});if(_19||(_14&&_13.name===_14.overlayItem.name)){return;}}this.inherited(arguments);},onReadySetupEditMode:function(){this.inherited(arguments);var _1b=this,_1c=function(){var _1d=_1b._activeEditorWrapper;if(_1d&&_1d.closeOnViewportClick){_1d.tryToStopEditing(false);}};this._formConnects.push(on(this._form,"mouseup",_1c));this.own(on(this.iframeWithOverlay.iframe,"mouseup",_1c));},placeForm:function(_1e){_1e.set("fitContainer",false);_1e.set("transitionMode","slideIn");this.editLayoutContainer.addChild(_1e,0);this._setupPullDownGesture(_1e);},_setupPullDownGesture:function(_1f){var _20=this;this._pullDownGesture=_6(_20.iframeWithOverlay.previewContainer,{isShown:false,show:function(){this.isShown=null;_4(_20.editLayoutContainer.selectChild(_1f),_2.hitch(this,function(){this.isShown=true;_20.iframeWithOverlay.onViewportPullDown();}),_2.hitch(this,function(){this.isShown=false;_20.iframeWithOverlay.onViewportPullDown();}));},hide:function(){this.isShown=null;_4(_20.editLayoutContainer.selectChild(_20.iframeWithOverlay),_2.hitch(this,function(){this.isShown=false;_20.iframeWithOverlay.onViewportPullDown();}),_2.hitch(this,function(){this.isShown=true;_20.iframeWithOverlay.onViewportPullDown();}));}});this._pullDownGesture.addMouseWheelListener(_1f.domNode);if(_20.iframeWithOverlay.iframe.isInspectable()){this._setupIframeMouseWheelListeners();}},_setupIframeMouseWheelListeners:function(){var _21=this._pullDownGesture.addMouseWheelListener(this.iframeWithOverlay.iframe.getDocument());this._iframeConnects=[];this._iframeConnects.push(this.connect(this.iframeWithOverlay.iframe,"onLoad",function(){_21=this._pullDownGesture.addMouseWheelListener(this.iframeWithOverlay.iframe.getDocument());}));this._iframeConnects.push(this.connect(this.iframeWithOverlay.iframe,"onUnload",function(){_21&&_21.remove();}));},_teardownIframeMouseWheelListeners:function(){if(this._iframeConnects){var c;while((c=this._iframeConnects.pop())){this.disconnect(c);}c=null;this._iframeConnects=null;}},_removePullDownGesture:function(){this._teardownIframeMouseWheelListeners();if(this._pullDownGesture){this._pullDownGesture.destroy();this._pullDownGesture=null;}},_destroyOverlay:function(){this.inherited(arguments);this._removeViewModelWatches();},removeForm:function(_22){this._removePullDownGesture();this.editLayoutContainer.leftOver=_22;return false;}});});